name: Backend CI & Deploy

on:
  push:
    branches:
      - '*' 

jobs:
  test-and-deploy:
    name: Test, Build & Deploy
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [22] # Node version to test

    steps:
      # 1. Checkout the code
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}

      # 3. Print Environment Secrets (optional)
      - name: Print Env Secrets
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PORT: ${{ secrets.PORT }}
        run: |
          echo "Secret 1 is: $MONGO_URI"
          echo "Secret 2 is: $JWT_SECRET"
          echo "Secret 3 is: $PORT"

      # 4. Install backend dependencies
      - name: Install Backend Dependencies
        working-directory: ./backend
        run: |
          npm install --global yarn
          yarn --version
          yarn install

      # 5. Install frontend dependencies & build
      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: |
          sudo rm -rf ./build
          yarn install
          yarn run build

      # 6. Run backend tests
      - name: Run Backend Tests
        env:
          MONGO_URI: ${{ secrets.MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          PORT: ${{ secrets.PORT }}
        working-directory: ./backend
        run: npm test

      # 7. Prepare backend .env
      - name: Setup Backend .env
        run: |
          cd ./backend
          touch .env
          echo "${{ secrets.PROD }}" > .env

      # 8. Deploy to EC2
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.AWS_SERVER_IP }}
          username: ec2-user        # change to 'ubuntu' if needed
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            echo "Deploying backend..."
            cd /home/ec2-user/your-project-directory
            git pull origin main
            npm install
            pm2 restart all

